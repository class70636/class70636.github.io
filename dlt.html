<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .custom-no-arrow::after {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container-fluid" style="width: 80%;">
        <div class="row">
            <div class="col">
                <div class="container">
                    <div class="row">
                        <div class="mt-3">
                            <label for="checkNumbers" class="form-label">輸入需要檢查的號碼</label>
                            <textarea class="form-control" id="checkNumbers" rows="3"
                                style="max-height: 500px; min-height: 300px;"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-primary" onclick="checkReapeatOfSelf()">組內檢查</button>
                            <button type="button" class="btn btn-success"
                                onclick="checkReapeatOfHistory()">與歷史紀錄檢查</button>
                            <button type="button" class="btn btn-danger" onclick="removeSearching()">清除</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-warning"
                                onclick="checkHistoryOfSelf()">歷史紀錄組內檢查</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="mt-3">
                    <div class="accordion" id="repeatResult">
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center" id="loadingModalBody">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span>讀取資料中...</span>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script>

        var myModal;
        document.addEventListener("DOMContentLoaded", () => {
            myModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            myModal.show();

            //抓取大樂透資料
            catchDatas();
        });

        var LTDDatas = [];
        function catchDatas() {
            //抓取日為2007-01至今
            var startDate = new Date('2007-01');
            var endDate = new Date();

            var fetchError = false;

            // 收集所有 fetch 的 Promise
            const fetchPromises = [];

            while (startDate <= endDate) {
                const dateFormatt = `${startDate.getFullYear()}-${(startDate.getMonth() + 1).toString().padStart(2, '0')}`;
                const fetchPromise = fetch(`https://api.taiwanlottery.com/TLCAPIWeB/Lottery/Lotto649Result?period&month=${dateFormatt}`)
                    .then(response => response.json())
                    .then(response => {
                        // const temp = response.content.lotto649Res;
                        // temp.forEach(t => {
                        //     if (t.length > 0) {
                        //         t.drawNumberSize.pop();
                        //         tempData.push(t.drawNumberSize);
                        //     }
                        // });
                        if (response.content.totalSize > 0)
                            response.content.lotto649Res.forEach(n => {
                                n.drawNumberSize.pop();
                                for (let i = 0; i < n.drawNumberSize.length; i++)
                                    n.drawNumberSize[i] = n.drawNumberSize[i].toString();
                                LTDDatas.push(n);
                            })
                    })
                    .catch(error => {
                        console.log(`Error: ${error}`);
                        const loadingModalBody = document.getElementById('loadingModalBody');
                        loadingModalBody.innerHTML = `
                        <i class="bi bi-arrow-clockwise text-danger"></i> 資料讀取失敗，請重新整理
                        `;
                        fetchError = true;
                    });

                fetchPromises.push(fetchPromise);

                startDate.setMonth(startDate.getMonth() + 1);
            }

            Promise.all(fetchPromises).then(() => {
                if (!fetchError)
                    myModal.hide();
            }).catch(error => {
                console.log(`Error: ${error}`);
            });

            // console.log(LTDDatas);
        }

        var checkNumbersArr = [];
        function checkReapeatOfSelf() {
            checkNumbersArr = []
            const checkNumbers = document.getElementById('checkNumbers');
            if (checkNumbers.value.length == 0) return;
            const period = checkNumbers.value.split('\n');
            period.forEach(n => {
                checkNumbersArr.push(n.split(','));
            })
            // console.log(checkNumbersArr);

            const repeatResult = document.getElementById('repeatResult');
            repeatResult.innerHTML = '';
            repeatCalc();


            function repeatCalc() {
                var temp_data = [];

                for (let i = 0; i < checkNumbersArr.length; i++) {
                    // 計算重複
                    var counts = {
                        4: [],
                        5: [],
                        6: []
                    };

                    const arr1 = checkNumbersArr[i];
                    const uniqueNumbers1 = new Set(arr1);

                    for (let j = 0; j < checkNumbersArr.length; j++) {
                        if (i == j) continue;
                        const arr2 = checkNumbersArr[j];
                        const uniqueNumbers2 = new Set(arr2);

                        var commonNumbers = [...uniqueNumbers1].filter(num => uniqueNumbers2.has(num));
                        var commonCount = commonNumbers.length;

                        if (commonCount >= 4 && commonCount <= 6) {
                            // counts[commonCount]++;
                            counts[commonCount].push(j);
                        }
                        // total_counts++;
                    }

                    temp_data.push(counts);
                }

                // console.log(temp_data);
                for (let i = 0; i < temp_data.length; i++) {
                    const cna = checkNumbersArr[i];
                    let temp_str = `[ ${cna[0]} , ${cna[1]} , ${cna[2]} , ${cna[3]} , ${cna[4]} , ${cna[5]} ]`;
                    //有重複的次數是否大於0
                    const repeat_counts = temp_data[i][4].length + temp_data[i][5].length + temp_data[i][6].length;
                    const btn_element = `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${i}">
                                <button class="accordion-button collapsed ${repeat_counts == 0 ? `custom-no-arrow` : ``}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse-${i}" aria-expanded="false"
                                    aria-controls="collapse-${i}" ${repeat_counts == 0 ? `disabled` : ``}>
                                    ${repeat_counts == 0 ? `<i class="bi bi-check-square-fill text-success"></i>` : `<i class="bi bi-exclamation-triangle-fill text-warning"></i>`}　#${i + 1}　${temp_str}
                                </button>
                            </h2>
                            <div id="collapse-${i}" class="accordion-collapse collapse" aria-labelledby="heading-${i}"
                                data-bs-parent="#repeatResult">
                                <div class="accordion-body">
                                    ${getAccBody()}
                                </div>
                            </div>
                        </div>
                    `;
                    repeatResult.innerHTML += btn_element;

                    function getAccBody() {
                        let temp = ``;
                        for (let j = 4; j <= 6; j++) {
                            if (temp_data[i][j].length == 0) continue;
                            let temp2 = ``;
                            for (let k = 0; k < temp_data[i][j].length; k++) {
                                const n = temp_data[i][j];
                                const index = n[k];
                                const temp3 = `[ ${checkNumbersArr[index][0]} , ${checkNumbersArr[index][1]} , ${checkNumbersArr[index][2]} , ${checkNumbersArr[index][3]} , ${checkNumbersArr[index][4]} , ${checkNumbersArr[index][5]} ]`;
                                temp2 += `#${n[k] + 1}　${temp3}<br>`;
                            }
                            temp += `
                            <div class="card mb-1">
                                <div class="card-header">
                                    與以下組別有 ${j} 個重複
                                </div>
                                <div class="card-body">
                                    ${temp2}
                                </div>
                            </div>
                            `;
                        }
                        return temp;
                    }
                }
            }

        }
        var temp_data = [];
        function checkReapeatOfHistory() {

            checkNumbersArr = []
            const checkNumbers = document.getElementById('checkNumbers');
            if (checkNumbers.value.length == 0) return;
            const period = checkNumbers.value.split('\n');
            period.forEach(n => {
                checkNumbersArr.push(n.split(','));
            })
            // console.log(checkNumbersArr);

            const repeatResult = document.getElementById('repeatResult');
            repeatResult.innerHTML = '';

            repeatCalc();

            function repeatCalc() {
                temp_data = [];
                for (let i = 0; i < checkNumbersArr.length; i++) {
                    // 計算重複
                    var counts = {
                        4: [],
                        5: [],
                        6: []
                    };

                    const arr1 = checkNumbersArr[i];
                    const uniqueNumbers1 = new Set(arr1);

                    //與歷史紀錄檢查
                    for (let j = 0; j < LTDDatas.length; j++) {
                        const arr2 = LTDDatas[j].drawNumberSize;
                        const uniqueNumbers2 = new Set(arr2);

                        var commonNumbers = [...uniqueNumbers1].filter(num => uniqueNumbers2.has(num));
                        var commonCount = commonNumbers.length;

                        if (commonCount >= 4 && commonCount <= 6) {
                            // counts[commonCount]++;
                            counts[commonCount].push(j);
                        }
                        // total_counts++;
                    }

                    temp_data.push(counts);
                }

                // console.log(temp_data);

                for (let i = 0; i < temp_data.length; i++) {
                    const cna = checkNumbersArr[i];
                    let temp_str = `[ ${cna[0]} , ${cna[1]} , ${cna[2]} , ${cna[3]} , ${cna[4]} , ${cna[5]} ]`;
                    //有重複的次數是否大於0
                    const repeat_counts = temp_data[i][4].length + temp_data[i][5].length + temp_data[i][6].length;
                    const btn_element = `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${i}">
                                <button class="accordion-button collapsed ${repeat_counts == 0 ? `custom-no-arrow` : ``}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse-${i}" aria-expanded="false"
                                    aria-controls="collapse-${i}" ${repeat_counts == 0 ? `disabled` : ``}>
                                    ${repeat_counts == 0 ? `<i class="bi bi-check-square-fill text-success"></i>` : `<i class="bi bi-exclamation-triangle-fill text-warning"></i>`}　#${i + 1}　${temp_str}
                                </button>
                            </h2>
                            <div id="collapse-${i}" class="accordion-collapse collapse" aria-labelledby="heading-${i}"
                                data-bs-parent="#repeatResult">
                                <div class="accordion-body">
                                    ${getAccBody()}
                                </div>
                            </div>
                        </div>
                    `;
                    repeatResult.innerHTML += btn_element;

                    function getAccBody() {
                        let card_body = ``;
                        for (let j = 4; j <= 6; j++) {
                            if (temp_data[i][j].length == 0) continue;
                            const drawNumbers = temp_data[i][j]; //一堆重複的期數, arr
                            let repeatedPeriod = ``;
                            for (let k = 0; k < drawNumbers.length; k++) {
                                const drawIndex = drawNumbers[k];
                                const drawNumber = LTDDatas[drawIndex].drawNumberSize;
                                const drawNumberDisplay = `[ ${drawNumber[0]} , ${drawNumber[1]} , ${drawNumber[2]} , ${drawNumber[3]} , ${drawNumber[4]} , ${drawNumber[5]} ]`;
                                const period = LTDDatas[drawIndex].period;
                                repeatedPeriod += `#${period}　${drawNumberDisplay}<br>`;
                            }
                            card_body += `
                            <div class="card mb-1">
                                <div class="card-header">
                                    與以下期數有 ${j} 個重複
                                </div>
                                <div class="card-body">
                                    ${repeatedPeriod}
                                </div>
                            </div>
                            `
                        }
                        return card_body;
                    }
                }
            }
        }

        function checkHistoryOfSelf() {
            const repeatResult = document.getElementById('repeatResult');
            repeatResult.innerHTML = '';

            // var temp_data = []; //紀錄每期分別重複4,5,6個數字的統計

            // 計算重複
            var counts = {
                4: 0,
                5: 0,
                6: 0
            };

            var total_counts = 0;

            for (let i = 0; i < LTDDatas.length; i++) {


                const arr1 = LTDDatas[i].drawNumberSize;
                const uniqueNumbers1 = new Set(arr1);

                for (let j = 0; j < LTDDatas.length; j++) {
                    if (i == j) continue;
                    const arr2 = LTDDatas[j].drawNumberSize;
                    const uniqueNumbers2 = new Set(arr2);

                    var commonNumbers = [...uniqueNumbers1].filter(num => uniqueNumbers2.has(num));
                    var commonCount = commonNumbers.length;

                    if (commonCount >= 4 && commonCount <= 6) {
                        counts[commonCount]++;
                        break;
                    }
                }
            }

            console.log(total_counts);            

            const resultTable = `
            <label class="form-label">總抓取期數: ${LTDDatas.length}</label>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <td>重複幾個</td>
                        <td>組數</td>
                        <td>百分比</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>4</td>
                        <td>${counts[4]}</td>
                        <td>${((counts[4] / LTDDatas.length) * 100).toFixed(4)} %</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>${counts[5]}</td>
                        <td>${((counts[5] / LTDDatas.length) * 100).toFixed(4)} %</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>${counts[6]}</td>
                        <td>${((counts[6] / LTDDatas.length) * 100).toFixed(4)} %</td>
                    </tr>
                </tbody>
            </table>
            `;

            repeatResult.innerHTML += resultTable;
        }

        function removeSearching() {
            const checkNumbers = document.getElementById('checkNumbers');
            checkNumbers.value = '';

            const repeatResult = document.getElementById('repeatResult');
            repeatResult.innerHTML = '';
        }
    </script>
</body>

</html>